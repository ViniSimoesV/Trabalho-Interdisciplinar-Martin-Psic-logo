async function carregarSessoesAgendadas() {
    try {
        //Obter o usu√°rio logado (ajuste conforme sua l√≥gica de autentica√ß√£o)
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        

        if (!usuarioLogado) {
        alert('Voc√™ precisa estar logado para acessar esta p√°gina.');
        window.location.href = 'login.html';
        return;
    }

        //const usuCodigo = usuarioLogado.usucodigo;
        const pacienteId = usuarioLogado.usucodigo;

        if (usuarioLogado) {
        const userName = usuarioLogado.usunome || 'Usu√°rio';
        document.getElementById('userInfo').textContent = `Ol√°, ${userName}`;
    }
        
        if (!usuarioLogado.usucodigo) {

            console.error('ID do usu√°rio n√£o encontrado');
            document.getElementById('horariosList').innerHTML = 
                '<p class="error">Erro: ID do usu√°rio n√£o encontrado</p>';
            return;
        }

        //console.log('Buscando agendamentos para usu√°rio:', usuCodigo);
        console.log('Buscando agendamentos para usu√°rio:', pacienteId);
        
        const response = await fetch(`http://localhost:8080/agendamentos/usuario/${pacienteId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const agendamentos = await response.json();
            console.log('Agendamentos carregados:', agendamentos);
            exibirAgendamentos(agendamentos);
        } else {
            console.error('Erro ao carregar agendamentos:', response.status);
            document.getElementById('horariosList').innerHTML = 
                '<p class="error">Erro ao carregar agendamentos. Tente novamente.</p>';
        }
    } catch (error) {
        console.error('Erro:', error);
        document.getElementById('horariosList').innerHTML = 
            '<p class="error">Erro de conex√£o com o servidor</p>';
    }
}

function exibirAgendamentos(agendamentos) {
    const container = document.getElementById('horariosList');

    if (!agendamentos || agendamentos.length === 0) {
        container.innerHTML = `
            <div class="no-sessions">
                <p>üìÖ Nenhuma sess√£o agendada no momento</p>
                <a href="agendarHorario.html" class="btn-agendar">Agendar Primeira Sess√£o</a>
            </div>
        `;
        return;
    }

    container.innerHTML = agendamentos.map(agendamento => {
        
        // Tenta v√°rios nomes de campo poss√≠veis para data
        const rawData = agendamento.data 
                     || agendamento.dataSessao 
                     || agendamento.horarioData
                     || agendamento.startDate
                     || agendamento.date;

        const dataFormatada = formatarDataBrasileira(rawData);

        return `
            <div class="sessao-item">
                <div class="sessao-header">
                    <span class="sessao-data">${dataFormatada}</span>
                    <span class="sessao-status agendada">AGENDADA</span>
                </div>

                <div class="sessao-details">
                    <p><strong>Hor√°rio:</strong> ${agendamento.horario || '‚Äî'}</p>

                    <p><strong>Paciente:</strong> ${agendamento.paciente || agendamento.pacienteNome || '‚Äî'}</p>

                    <p><strong>Contato:</strong> 
                        ${(agendamento.telefone || '‚Äî')} - ${(agendamento.email || '‚Äî')}
                    </p>

                    ${agendamento.observacoes ? `
                        <p><strong>Observa√ß√µes:</strong> ${agendamento.observacoes}</p>
                    ` : ''}

                    <p><strong>Valor:</strong> 
                        R$ ${agendamento.valorSessao !== null && agendamento.valorSessao !== undefined 
                            ? agendamento.valorSessao 
                            : '‚Äî'}
                    </p>
                </div>

                <div class="sessao-actions">
                    <button class="btn-cancelar" 
                        onclick="cancelarAgendamento(${agendamento.agendamentoID})">
                        Cancelar
                    </button>
                    <button class="btn-reagendar" data-id="${agendamento.agendamentoID}" 
        data-data="${agendamento.data}" data-horario="${agendamento.horarioInicio}">
        Reagendar
    </button>
                </div>

                
            </div>
        `;
    }).join('');


    async function carregarSessoesAgendadas() {
    try {
        //Obter o usu√°rio logado (ajuste conforme sua l√≥gica de autentica√ß√£o)
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        

        if (!usuarioLogado) {
        alert('Voc√™ precisa estar logado para acessar esta p√°gina.');
        window.location.href = 'login.html';
        return;
    }

        //const usuCodigo = usuarioLogado.usucodigo;
        const pacienteId = usuarioLogado.usucodigo;

        if (usuarioLogado) {
        const userName = usuarioLogado.usunome || 'Usu√°rio';
        document.getElementById('userInfo').textContent = `Ol√°, ${userName}`;
    }
        
        if (!usuarioLogado.usucodigo) {

            console.error('ID do usu√°rio n√£o encontrado');
            document.getElementById('horariosList').innerHTML = 
                '<p class="error">Erro: ID do usu√°rio n√£o encontrado</p>';
            return;
        }

        //console.log('Buscando agendamentos para usu√°rio:', usuCodigo);
        console.log('Buscando agendamentos para usu√°rio:', pacienteId);
        
        const response = await fetch(`http://localhost:8080/agendamentos/usuario/${pacienteId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const agendamentos = await response.json();
            console.log('Agendamentos carregados:', agendamentos);
            exibirAgendamentos(agendamentos);
        } else {
            console.error('Erro ao carregar agendamentos:', response.status);
            document.getElementById('horariosList').innerHTML = 
                '<p class="error">Erro ao carregar agendamentos. Tente novamente.</p>';
        }
    } catch (error) {
        console.error('Erro:', error);
        document.getElementById('horariosList').innerHTML = 
            '<p class="error">Erro de conex√£o com o servidor</p>';
    }
}

function exibirAgendamentos(agendamentos) {
    const container = document.getElementById('horariosList');

    if (!agendamentos || agendamentos.length === 0) {
        container.innerHTML = `
            <div class="no-sessions">
                <p>üìÖ Nenhuma sess√£o agendada no momento</p>
                <a href="agendarHorario.html" class="btn-agendar">Agendar Primeira Sess√£o</a>
            </div>
        `;
        return;
    }

    container.innerHTML = agendamentos.map(agendamento => {
        
        // Tenta v√°rios nomes de campo poss√≠veis para data
        const rawData = agendamento.data 
                     || agendamento.dataSessao 
                     || agendamento.horarioData
                     || agendamento.startDate
                     || agendamento.date;

        const dataFormatada = formatarDataBrasileira(rawData);

        return `
            <div class="sessao-item">
                <div class="sessao-header">
                    <span class="sessao-data">${dataFormatada}</span>
                    <span class="sessao-status agendada">AGENDADA</span>
                </div>

                <div class="sessao-details">
                    <p><strong>Hor√°rio:</strong> ${agendamento.horario || '‚Äî'}</p>

                    <p><strong>Paciente:</strong> ${agendamento.paciente || agendamento.pacienteNome || '‚Äî'}</p>

                    <p><strong>Contato:</strong> 
                        ${(agendamento.telefone || agendamento.paciente?.telefone || usuarioLogado?.telefone || '‚Äî')} - ${(agendamento.email || agendamento.paciente?.usuemail || usuarioLogado?.usuemail || '‚Äî')}
                    </p>

                    ${agendamento.observacoes ? `
                        <p><strong>Observa√ß√µes:</strong> ${agendamento.observacoes}</p>
                    ` : ''}

                    <p><strong>Valor:</strong> 
                        R$ ${agendamento.valorSessao !== null && agendamento.valorSessao !== undefined 
                            ? agendamento.valorSessao 
                            : '‚Äî'}
                    </p>
                </div>

                <div class="sessao-actions">
                    <button class="btn-cancelar" 
                        onclick="cancelarAgendamento(${agendamento.agendamentoID})">
                        Cancelar
                    </button>
                    <button class="btn-reagendar" data-id="${agendamento.agendamentoID}" 
        data-data="${agendamento.data}" data-horario="${agendamento.horarioInicio}">
        Reagendar
    </button>
                </div>

                
            </div>
        `;
    }).join('');
}
// Adicionar evento de clique aos bot√µes de reagendar
document.querySelectorAll('.btn-reagendar').forEach(btn => {
    btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const data = btn.dataset.data;
        const horario = btn.dataset.horario;

        reagendarSessao(id, data, horario);
    });
});





// Uso: aceitar strings ISO, objetos Date, e retornar fallback se inv√°lido
function formatarDataBrasileira(dataInput) {
  // 1) Guard: se null/undefined
  if (dataInput === null || dataInput === undefined) return 'Data indispon√≠vel';

  // 2) Se j√° for um objeto Date
  if (dataInput instanceof Date) {
    if (isNaN(dataInput)) return 'Data inv√°lida';
    return dataInput.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }

  // 3) Se for string ‚Äî tenta criar Date e fallback para parsing manual
  if (typeof dataInput === 'string') {
    // tenta Date primeiro (cobre ISO "YYYY-MM-DDTHH:mm:ss" e varia√ß√µes)
    const parsed = new Date(dataInput);
    if (!isNaN(parsed)) {
      return parsed.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // se n√£o for parse√°vel, tenta extrair parte antes do 'T' (formato YYYY-MM-DD)
    const datePart = dataInput.split('T')[0];
    if (datePart) {
      const parts = datePart.split('-');
      if (parts.length >= 3) {
        const [year, month, day] = parts;
        return `${day}/${month}/${year}`;
      }
    }
  }

  // 4) Qualquer outro caso inv√°lido
  return 'Data inv√°lida';
}


// Fun√ß√£o para cancelar agendamento
async function cancelarAgendamento(agendamentoID) {
    if (!confirm('Tem certeza que deseja cancelar este agendamento?')) {
        return;
    }

    try {
        const response = await fetch(`http://localhost:8080/agendamentos/${agendamentoID}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('Agendamento cancelado com sucesso!');
            carregarSessoesAgendadas(); // Recarregar a lista
        } else {
            const errorText = await response.text();
            alert('Erro ao cancelar: ' + errorText);
        }
    } catch (error) {
        console.error('Erro ao cancelar:', error);
        alert('Erro ao conectar com o servidor.');
    }

}

// Fun√ß√£o para reagendar sess√£o
function reagendarSessao(id, data, horario) {
    const confirmar = confirm('Tem certeza que deseja reagendar esta sess√£o?');
    if (!confirmar) return;

    const sessao = new Date(`${data}T${horario}`);
    const agora = new Date();
    const limite = new Date(agora.getTime() + 12 * 60 * 60 * 1000); // 12 horas √† frente

    if (sessao < limite) {
        alert("Reagendamento permitido somente at√© 12 horas antes da sess√£o.");
        return;
    }

    // Salvar dados no localStorage para pr√©-preencher o formul√°rio de agendamento
    localStorage.setItem('reagendamento', JSON.stringify({
        agendamentoID: id,
        data: data,
        horario: horario
    }));

    // Redireciona para a p√°gina de agendamento
    window.location.href = 'agendarHorario.html';
}



// Verificar autentica√ß√£o ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
    if (!usuarioLogado) {
        alert('Voc√™ precisa estar logado para acessar esta p√°gina.');
        window.location.href = 'login.html';
        return;
    }

    // Exibir informa√ß√µes do usu√°rio
    if (usuarioLogado) {
        const userName = usuarioLogado.usunome || 'Usu√°rio';
        document.getElementById('userInfo').textContent = `Ol√°, ${userName}`;
    }

    // Configurar logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('Deseja realmente sair?')) {
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('userId');
            localStorage.removeItem('usuCodigo');
            localStorage.removeItem('userNome');
            localStorage.removeItem('userType');
            window.location.href = 'login.html';
        }
    });

    // Carregar agendamentos
    carregarSessoesAgendadas();
});

// Fun√ß√£o para cancelar agendamento com autentica√ß√£o
async function cancelarAgendamento(id) {
    if (!confirm('Tem certeza que deseja cancelar este agendamento?')) {
        return;
    }

    const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));

    try {
        const response = await fetch(`http://localhost:8080/agendamentos/${id}`, {
            method: 'DELETE',
            headers: {
                "Content-Type": "application/json",
                "usuCodigo": usuario.usucodigo
            }
        });

        if (response.ok) {
            alert('Agendamento cancelado com sucesso!');
            carregarSessoesAgendadas(); // Recarrega a lista
        } else {
            const errorText = await response.text();
            alert('Erro ao cancelar: ' + errorText);
        }
    } catch (error) {
        console.error('Erro ao cancelar:', error);
        alert('Erro ao conectar com o servidor.');
    }
}



}





// Uso: aceitar strings ISO, objetos Date, e retornar fallback se inv√°lido
function formatarDataBrasileira(dataInput) {
  // 1) Guard: se null/undefined
  if (dataInput === null || dataInput === undefined) return 'Data indispon√≠vel';

  // 2) Se j√° for um objeto Date
  if (dataInput instanceof Date) {
    if (isNaN(dataInput)) return 'Data inv√°lida';
    return dataInput.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }

  // 3) Se for string ‚Äî tenta criar Date e fallback para parsing manual
  if (typeof dataInput === 'string') {
    // tenta Date primeiro (cobre ISO "YYYY-MM-DDTHH:mm:ss" e varia√ß√µes)
    const parsed = new Date(dataInput);
    if (!isNaN(parsed)) {
      return parsed.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // se n√£o for parse√°vel, tenta extrair parte antes do 'T' (formato YYYY-MM-DD)
    const datePart = dataInput.split('T')[0];
    if (datePart) {
      const parts = datePart.split('-');
      if (parts.length >= 3) {
        const [year, month, day] = parts;
        return `${day}/${month}/${year}`;
      }
    }
  }

  // 4) Qualquer outro caso inv√°lido
  return 'Data inv√°lida';
}


// Fun√ß√£o para cancelar agendamento
async function cancelarAgendamento(agendamentoID) {
    if (!confirm('Tem certeza que deseja cancelar este agendamento?')) {
        return;
    }

    try {
        const response = await fetch(`http://localhost:8080/agendamentos/${agendamentoID}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('Agendamento cancelado com sucesso!');
            carregarSessoesAgendadas(); // Recarregar a lista
        } else {
            const errorText = await response.text();
            alert('Erro ao cancelar: ' + errorText);
        }
    } catch (error) {
        console.error('Erro ao cancelar:', error);
        alert('Erro ao conectar com o servidor.');
    }

}

// Fun√ß√£o para reagendar sess√£o
function reagendarSessao(id, data, horario) {
    const confirmar = confirm('Tem certeza que deseja reagendar esta sess√£o?');
    if (!confirmar) return;

    const sessao = new Date(`${data}T${horario}`);
    const agora = new Date();
    const limite = new Date(agora.getTime() + 12 * 60 * 60 * 1000); // 12 horas √† frente

    if (sessao < limite) {
        alert("Reagendamento permitido somente at√© 12 horas antes da sess√£o.");
        return;
    }

    // Salvar dados no localStorage para pr√©-preencher o formul√°rio de agendamento
    localStorage.setItem('reagendamento', JSON.stringify({
        agendamentoID: id,
        data: data,
        horario: horario
    }));

    // Redireciona para a p√°gina de agendamento
    window.location.href = 'agendarHorario.html';
}



// Verificar autentica√ß√£o ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
    if (!usuarioLogado) {
        alert('Voc√™ precisa estar logado para acessar esta p√°gina.');
        window.location.href = 'login.html';
        return;
    }

    // Exibir informa√ß√µes do usu√°rio
    if (usuarioLogado) {
        const userName = usuarioLogado.usunome || 'Usu√°rio';
        document.getElementById('userInfo').textContent = `Ol√°, ${userName}`;
    }

    // Configurar logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('Deseja realmente sair?')) {
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('userId');
            localStorage.removeItem('usuCodigo');
            localStorage.removeItem('userNome');
            localStorage.removeItem('userType');
            window.location.href = 'login.html';
        }
    });

    // Carregar agendamentos
    carregarSessoesAgendadas();
});

// Fun√ß√£o para cancelar agendamento com autentica√ß√£o
async function cancelarAgendamento(id) {
    if (!confirm('Tem certeza que deseja cancelar este agendamento?')) {
        return;
    }

    const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));

    try {
        const response = await fetch(`http://localhost:8080/agendamentos/${id}`, {
            method: 'DELETE',
            headers: {
                "Content-Type": "application/json",
                "usuCodigo": usuario.usucodigo
            }
        });

        if (response.ok) {
            alert('Agendamento cancelado com sucesso!');
            carregarSessoesAgendadas(); // Recarrega a lista
        } else {
            const errorText = await response.text();
            alert('Erro ao cancelar: ' + errorText);
        }
    } catch (error) {
        console.error('Erro ao cancelar:', error);
        alert('Erro ao conectar com o servidor.');
    }
}


